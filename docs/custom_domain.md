# Custom DNS domain

Icarus uses [Serverless Domain Manager plugin](https://github.com/amplify-education/serverless-domain-manager)
(Also see https://serverless.com/blog/serverless-api-gateway-domain/)

To use it, you need to set up a custom public domain (or subdomain) on Route53 and add a valid cerrificarte to ACM (lambdas uses HTTPS).

The domain to use is defined in `./serverless.yml`. Change it to use a different domain

All stages are deployed to the same domain, using different basepaths.

The domain name is specified by the environment variable `ICARUS_DOMAIN`.
This domain must match with the certificate added to ACM (see below.)

## SSL Certificartes

I can't use ACM to issue certificates, directly, not being amble to receive the contact emails for the domain. 

I will use free certificates signed by [Let's encrypt](https://letsencrypt.org).
Please not these certificates **expires in 3 months** and have to be manually renewed and reloaded on ACM.

## Setup

This setup is required for preparing environments.

All stages use the same domain, so the domain setup is done once.

Many of the steps are manual at the moment.

### Generate SSL certificate

We need a valid, signed SSL certifcate for all our subdomains and we are using Let's Encrypt for it.

(This is definitely not the only possible process).

**The base domain must be hosted by Route53.**

1. Start an EC2 instance:
    * `t2.micro`
    * Public IP; accessible from the Internet on `http` and `https`
    * Must access the Internet (i.e. public subnet -> NAT Gateway)
    * I'm using Ubuntu 16.04, but any OS & distro supported by [Certbot](https://certbot.eff.org/) will work. We are using it only for generating the certificates, so the distro and the web server really don't matter!

2. Add DNS `A` (or `CNAME`) records to the zone, for all subdomains above, all pointing to the EC2 public IP
3. Install Apache httpd on the instance. 
    `sudo apt-get update; sudo apt-get install apache2`

4. Follow instructons for running Certbot on the OS installed on the instsance: https://certbot.eff.org/#ubuntuxenial-apache
    * The *Let's Encrypt* will access Apache to verify your identity, so don't run Certbot with `certonly`
    * When asked for domain names, add the subdomains you are going to use, space separated (wildcard domains are not supported, unfortunately)
    * When asked which apache config file to use, select #3 (`000-default-le-ssl.conf`). I haven't investigated if it makes any difference, but that worked for me ;)
    * Select "No redirect" (doesn't make any real difference)

5. Download the certificats, private key and credentials directory generated by certbot
    * Don't forget the credentials directory `/etc/letsencrypt`. You will need it to renew the certificate!

6. You may now safely terminate the EC2 instance

### Setup certificate on ACM

Import the certificate in ACM. Quite straightforward.

You only need to split the Certificate Body from the Certificate chain, as Certbot put both into `fullchain.pem`

### Create the lambdas custom domain

This is handled by Serverless Domain Manager plugin:

```
sls create_domain
```

This creates the record in Route53 and the API Gateway Custom Domain Name.

The certificate, uploaded in ACM, is automatically matched by DNS domain name.

API Gateway Custom Domain uses a CloudFormation distribution under the hood. 
This distribution is not directly visible from CloudFormation interface.

The distribution may take up to 40 mins to come up and the same time to be deleted.

To monitor the deployment status of the Custom domain: *AWS Console: Amazon API Gateway > Custom Domain Names*.
The ACM Certificate status takes a while "Initialising...".
I can't find any AWS CLI equivalent for retrieving that information.

### Certificate renewal

**TBD**
